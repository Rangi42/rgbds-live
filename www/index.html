<html>
<head>

<script src="rgbasm"></script>
<script src="rgblink"></script>
<script src="rgbfix"></script>
<script src="lz-string.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-tomorrow.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-assembly_x86.min.js"></script>

<script type="text/javascript" src="js/GameBoyCore.js"></script>

<script>
var settings = [                        //Some settings.
    true,                               //Turn on sound.
    true,                               //Boot with boot ROM first?
    false,                              //Give priority to GameBoy mode
    1,                                  //Volume level set.
    true,                               //Colorize GB mode?
    false,                              //Disallow typed arrays?
    8,                                  //Interval for the emulator loop.
    10,                                 //Audio buffer minimum span amount over x interpreter iterations.
    20,                                 //Audio buffer maximum span amount over x interpreter iterations.
    false,                              //Override to allow for MBC1 instead of ROM only (compatibility for broken 3rd-party cartridges).
    false,                              //Override MBC RAM disabling and always allow reading and writing to the banks.
    false,                              //Use the GameBoy boot ROM instead of the GameBoy Color boot ROM.
    false,                              //Scale the canvas in JS, or let the browser scale the canvas?
    true,                               //Use image smoothing based scaling?
    [true, true, true, true]            //User controlled channel enables.
];

var logFunction = function(str) { document.getElementById('output').value += str + "\n"; }
var build_busy = false;

function compileCode()
{
    var code = editor.getValue();
    document.getElementById('output').value = "";
    location.hash = LZString.compressToEncodedURIComponent(code);

    logFunction("Running rgbasm");
    createRgbAsm({
        'arguments': ['input.asm', '-o', 'output.o'],
        'preRun': function(m) {
            var FS = m['FS'];
            FS.writeFile("input.asm", code);
        },
        'print': logFunction,
        'printErr': logFunction,
    }).then(function(m) {
        var FS = m['FS'];
        try { var obj_file = FS.readFile("output.o"); } catch { return; }
        logFunction("Running rgblink");
        createRgbLink({
            'arguments': ['input.o', '-o', 'output.gb', '-x'],
            'preRun': function(m) {
                var FS = m['FS'];
                FS.writeFile("input.o", obj_file);
            },
            'print': logFunction,
            'printErr': logFunction,
        }).then(function(m) {
            var FS = m['FS'];
            try { var gb_file = FS.readFile("output.gb"); } catch { return; }
            var hex = Array.prototype.map.call(gb_file, x => ('00' + x.toString(16)).slice(-2)).join(' ');
            for(var n=0; n<hex.length; n+=3*32)
                logFunction(hex.slice(n, n + 3*32));
        });
    });
}

window.addEventListener('DOMContentLoaded', (event) => {
    editor = ace.edit("input");
    editor.setTheme("ace/theme/tomorrow");
    editor.session.setMode("ace/mode/assembly_x86");

    if (location.hash.length > 1)
    {
        editor.setValue(LZString.decompressFromEncodedURIComponent(location.hash.slice(1)));
    }
    editor.session.on('change', function(delta) { compileCode() });
    compileCode();
});

</script>
</head>
<body>
<div id="input" style="height: 50%; width: 100%">
SECTION "bank00", ROM0[$0000]
  stop
</div>
<textarea style="height: 50%; width: 100%" id="output" readonly></textarea>
</body>
</html>
