<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="google" content="notranslate">
<link rel="stylesheet" href="css/style.css">

<script src="wasm/rgbasm"></script>
<script src="wasm/rgblink"></script>
<script src="wasm/rgbfix"></script>
<script src="js/hardware.inc.js"></script>
<script src="js/lz-string.min.js"></script>
<script src="js/compiler.js"></script>
<script src="js/emulator.js"></script>
<script src="js/storage.js"></script>

<script src="js/ace/ace.js"></script>
<script src="js/ace/theme-tomorrow.js"></script>
<script src="js/ace/ext-language_tools.js"></script>
<script src="js/ace/mode-gbz80.js"></script>
<script src="js/ace/complete-gbz80.js"></script>
<script src="wasm/binjgb.js"></script>

<script>
"use strict";

var editor;
var cpu_line_marker = undefined;
var start_address;
var rom;
var addr_to_line = {}
var line_to_addr = {}
var cpu_step_interval_id;
var emu_view = "";
var current_file = "main.asm";

compiler.setLogCallback(function(str) {
    var output = document.getElementById('output');
    output.value += str + "\n";
    output.scrollTop = output.clientHeight;
});
compiler.setErrorCallback(function(type, filename, line_nr, str) {
    if (filename != current_file)
        return;
    var annotations = editor.session.getAnnotations();
    annotations.push({row: line_nr-1, column: 0, type: type, text: str});
    editor.session.setAnnotations(annotations);
});

function compileCode()
{
    destroyEmulator();
    storage.update(current_file, editor.getValue());
    document.getElementById('output').value = "";
    editor.session.clearAnnotations();

    compiler.compile(function(_rom_file, _start_address, _addr_to_line) {
        if (typeof(_rom_file) == 'undefined') {
            return;
        }
        rom = _rom_file
        start_address = _start_address
        addr_to_line = _addr_to_line
        for(var addr in addr_to_line) {
            var [file, line] = addr_to_line[addr];
            if (typeof(line_to_addr[line]) == "undefined")
                line_to_addr[line] = [];
            line_to_addr[line].push(addr);
        }
        updateTextView();
    })
}

function destroyEmulator()
{
    emulator.destroy();

    addr_to_line = {}
    line_to_addr = {}
    rom = undefined;

    if (typeof(cpu_line_marker) != "undefined")
    {
        editor.session.removeMarker(cpu_line_marker);
        cpu_line_marker = undefined;
    }
}

function initEmulator()
{
    if (typeof(rom) == "undefined") return;
    
    emulator.init(document.getElementById("emulator_screen_canvas"), rom);
    emulator.setPC(start_address)
    updateCpuState();
    updateBreakpoints();
}

function stepEmulator(step_type)
{
    if (!emulator.isAvailable())
    {
        initEmulator();
        return;
    }
    var result = emulator.step(step_type);
    updateCpuState();
    return result
}

function updateBreakpoints()
{
    emulator.clearBreakpoints();
    var breakpoints = editor.session.getBreakpoints();
    for(var line_nr in breakpoints)
    {
        if (typeof(breakpoints[line_nr]) == "undefined") continue;
        line_nr = parseInt(line_nr) + 1;
        if (typeof(line_to_addr[line_nr]) == "undefined") continue;
        for(var addr of line_to_addr[line_nr])
            emulator.setBreakpoint(addr);
    }
}

function handleGBKey(keycode, down)
{
    //Map the directional keys and A/S to B/A and shift/enter to select/start
    if (keycode == 39) emulator.setKeyPad("right", down);
    if (keycode == 37) emulator.setKeyPad("left", down);
    if (keycode == 38) emulator.setKeyPad("up", down);
    if (keycode == 40) emulator.setKeyPad("down", down);
    if (keycode == 83) emulator.setKeyPad("a", down);
    if (keycode == 65) emulator.setKeyPad("b", down);
    if (keycode == 16) emulator.setKeyPad("select", down);
    if (keycode == 13) emulator.setKeyPad("start", down);
    if (keycode == 27) {
        document.getElementById("cpu_run_check").checked = false;
        document.getElementById("cpu_run_check").onclick();
    }
}

function toHex(num, digits)
{
    return "$" + ("0000" + num.toString(16)).slice(-digits);
}

function updateCpuState()
{
    if (typeof(cpu_line_marker) != "undefined")
    {
        editor.session.removeMarker(cpu_line_marker);
        cpu_line_marker = undefined;
    }

    emulator.renderScreen()

    var pc = emulator.getPC();
    document.getElementById("cpu_pc").innerHTML = toHex(pc, 4)
    document.getElementById("cpu_sp").innerHTML = toHex(emulator.getSP(), 4)
    document.getElementById("cpu_a").innerHTML = toHex(emulator.getA(), 2);
    document.getElementById("cpu_bc").innerHTML = toHex(emulator.getBC(), 4);
    document.getElementById("cpu_de").innerHTML = toHex(emulator.getDE(), 4);
    document.getElementById("cpu_hl").innerHTML = toHex(emulator.getHL(), 4);
    document.getElementById("cpu_flags").innerHTML = emulator.getFlags();

    var file_line_nr = addr_to_line[pc];
    if (typeof(file_line_nr) == "undefined")
        file_line_nr = addr_to_line[pc - 1];
    if (typeof(file_line_nr) != "undefined" && file_line_nr[0] == current_file)
    {
        cpu_line_marker = editor.session.addMarker(new ace.Range(file_line_nr[1]-1, 0, file_line_nr[1]-1, 1), "cpuLineMarker", "fullLine");
        
        if (!document.getElementById("cpu_run_check").checked)
            editor.scrollToLine(file_line_nr[1]-1, true, false, function() {});
    }
    updateVRamCanvas();
    updateTextView();
}

function updateVRamCanvas()
{
    var canvas = document.getElementById("emulator_vram_canvas");
    if (canvas.style.display != "") return;

    if (emu_view == "vram")
        emulator.renderVRam(canvas);
    if (emu_view == "bg0")
        emulator.renderBackground(canvas, 0);
    if (emu_view == "bg1")
        emulator.renderBackground(canvas, 1);
}

function updateTextView()
{
    var display_text = document.getElementById("emulator_display_text");
    if (display_text.style.display != "") return;
    var data = rom;
    var bank_size = 0x4000;
    var offset = 0x0000;
    if (emu_view == "wram")
    {
        data = emulator.getWRam();
        bank_size = 0x1000;
        offset = 0xC000;
    }
    if (emu_view == "hram")
    {
        data = emulator.getHRam();
        bank_size = 0x1000;
        offset = 0xFF80;
    }
    if (emu_view == "io")
    {
        var text = "";
        var registers = [
            {name: "P1", value: 0xFF00},
            {name: "SB", value: 0xFF01},
            {name: "SC", value: 0xFF02},
            {name: "DIV", value: 0xFF04},
            {name: "TIMA", value: 0xFF05},
            {name: "TMA", value: 0xFF06},
            {name: "TAC", value: 0xFF07},
            {name: "IF", value: 0xFF0F},
            {name: "LCDC", value: 0xFF40},
            {name: "STAT", value: 0xFF41},
            {name: "SCY", value: 0xFF42},
            {name: "SCX", value: 0xFF43},
            {name: "LY", value: 0xFF44},
            {name: "LYC", value: 0xFF45},
            {name: "DMA", value: 0xFF46},
            {name: "BGP", value: 0xFF47},
            {name: "OBP0", value: 0xFF48},
            {name: "OBP1", value: 0xFF49},
            {name: "WY", value: 0xFF4A},
            {name: "WX", value: 0xFF4B},
            {name: "KEY1", value: 0xFF4D},
            {name: "VBK", value: 0xFF4F},
            {name: "RP", value: 0xFF56},
            {name: "BCPS", value: 0xFF68},
            {name: "BCPD", value: 0xFF69},
            {name: "OCPS", value: 0xFF6A},
            {name: "OCPD", value: 0xFF6B},
            {name: "SVBK", value: 0xFF70},
            {name: "IE", value: 0xFFFF},
        ]
        for(var reg_info of registers)
        {
            text += (reg_info.name + ":       ").slice(0, 6) + ('00' + emulator.readMem(reg_info.value).toString(16)).slice(-2) + "\n";
        }
        display_text.value = text;
        return;
    }
    if (typeof(data) == "undefined") return;

    var text = "         0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f\n";
    for(var n=0; n<data.length; n+=16)
    {
        var hex = Array.prototype.map.call(data.slice(n, n + 16), x => ('00' + x.toString(16)).slice(-2)).join(' ');
        var bank = ~~(n / bank_size);
        var addr = (n & (bank_size - 1))
        if (bank > 0)
            addr += bank_size;
        text += ("00" + bank.toString(16)).slice(-2) + ":" + ("0000" + (addr + offset).toString(16)).slice(-4) + " " + hex + "\n";
    }
    display_text.value = text;
}

function updateFileList()
{
    var filelist = document.getElementById("filelist");
    filelist.textContent = "";
    
    for (const name of Object.keys(storage.getFiles()).sort()) {
        var entry = document.createElement('li');
        entry.textContent = name;
        filelist.appendChild(entry);
        
        if (Object.keys(storage.getFiles()).length > 1)
        {
            var delbutton = document.createElement('button');
            delbutton.textContent = "x";
            entry.appendChild(delbutton);
            delbutton.onclick = function(e) {
                e.cancelBubble = true;
                deleteFile(name);
            }
        }
        
        if (name == current_file)
            entry.className = "active";
    }
}

function deleteFile(name)
{
    storage.update(name, null);
    if (current_file == name)
    {
        current_file = Object.keys(storage.getFiles()).sort()[0];
        editor.setValue(storage.getFiles()[current_file]);
    }
    updateFileList();
}

window.addEventListener('DOMContentLoaded', (event) => {
    editor = ace.edit("input");
    editor.setTheme("ace/theme/tomorrow");
    editor.session.setMode("ace/mode/gbz80");
    editor.setOptions({
        tabSize: 2,
        useSoftTabs: true,
        enableLiveAutocompletion: true,
        enableSnippets: true,
    });
    editor.completers = [gbz80Completer]

    storage.load();
    updateFileList();
    document.getElementById("filelist").onclick = function(e)
    {
        current_file = e.target.childNodes[0].wholeText;
        editor.setValue(storage.getFiles()[current_file]);
        updateFileList();
        updateCpuState();
    }
    document.getElementById("newfile").onclick = function()
    {
        var result = prompt("Name of new file?");
        if (!result) return;
        if (result.indexOf(".") < 0) result += ".asm";
        if (result in storage.getFiles()) return;
        current_file = result;
        storage.update(current_file, "");
        editor.setValue("");
        updateFileList();
    }

    editor.setValue(storage.getFiles()[current_file]);
    editor.session.on('change', function(delta) { if (editor.curOp && editor.curOp.command.name) compileCode(); });
    editor.on("guttermousedown", function(e) {
        var target = e.domEvent.target;

        if (target.className.indexOf("ace_gutter-cell") == -1)
            return;
        var row = e.getDocumentPosition().row;
        var breakpoints = e.editor.session.getBreakpoints();
        if (typeof(breakpoints[row]) == "undefined")
            e.editor.session.setBreakpoint(row);
        else
            e.editor.session.clearBreakpoint(row);
        updateBreakpoints();
        e.stop();
    });
    compileCode();

    document.getElementById("cpu_single_step").onclick = function() { stepEmulator("single"); };
    document.getElementById("cpu_frame_step").onclick = function() { stepEmulator("frame"); };
    document.getElementById("cpu_reset").onclick = function() { initEmulator(); };
    document.getElementById("cpu_run_check").onclick = function() {
        clearInterval(cpu_step_interval_id);
        if (document.getElementById("cpu_run_check").checked)
        {
            cpu_step_interval_id = setInterval(function() {
                if (!document.hidden)
                {
                    if (stepEmulator("run"))
                    {
                        clearInterval(cpu_step_interval_id);
                        document.getElementById("cpu_run_check").checked = false;
                    }
                }
            }, 16);
        }
    }
    var canvas = document.getElementById("emulator_screen_canvas");
    canvas.tabIndex = -1;
    canvas.onkeydown = function(e) {
        handleGBKey(e.keyCode, true);
        e.preventDefault();
    };
    canvas.onkeyup = function(e) {
        handleGBKey(e.keyCode, false);
        e.preventDefault();
    };    

    document.getElementById("emulator_display_screen").onclick = function() {
        document.getElementById("emulator_screen_canvas").style.display = "";
        document.getElementById("emulator_vram_canvas").style.display = "none";
        document.getElementById("emulator_display_text").style.display = "none";
        emu_view = "display";
    };
    document.getElementById("emulator_display_vram").onclick = function() {
        document.getElementById("emulator_screen_canvas").style.display = "none";
        document.getElementById("emulator_vram_canvas").style.display = "";
        document.getElementById("emulator_display_text").style.display = "none";
        emu_view = "vram";
        updateVRamCanvas();
    };
    document.getElementById("emulator_display_bg0").onclick = function() {
        document.getElementById("emulator_screen_canvas").style.display = "none";
        document.getElementById("emulator_vram_canvas").style.display = "";
        document.getElementById("emulator_display_text").style.display = "none";
        emu_view = "bg0";
        updateVRamCanvas();
    };
    document.getElementById("emulator_display_bg1").onclick = function() {
        document.getElementById("emulator_screen_canvas").style.display = "none";
        document.getElementById("emulator_vram_canvas").style.display = "";
        document.getElementById("emulator_display_text").style.display = "none";
        emu_view = "bg1";
        updateVRamCanvas();
    };
    document.getElementById("emulator_display_rom").onclick = function() {
        document.getElementById("emulator_screen_canvas").style.display = "none";
        document.getElementById("emulator_vram_canvas").style.display = "none";
        document.getElementById("emulator_display_text").style.display = "";
        emu_view = "rom";
        updateTextView();
    };
    document.getElementById("emulator_display_wram").onclick = function() {
        document.getElementById("emulator_screen_canvas").style.display = "none";
        document.getElementById("emulator_vram_canvas").style.display = "none";
        document.getElementById("emulator_display_text").style.display = "";
        emu_view = "wram";
        updateTextView();
    };
    document.getElementById("emulator_display_hram").onclick = function() {
        document.getElementById("emulator_screen_canvas").style.display = "none";
        document.getElementById("emulator_vram_canvas").style.display = "none";
        document.getElementById("emulator_display_text").style.display = "";
        emu_view = "hram";
        updateTextView();
    };
    document.getElementById("emulator_display_io").onclick = function() {
        document.getElementById("emulator_screen_canvas").style.display = "none";
        document.getElementById("emulator_vram_canvas").style.display = "none";
        document.getElementById("emulator_display_text").style.display = "";
        emu_view = "io";
        updateTextView();
    };
    
    document.getElementById("download_rom").onclick = function() {
        if (typeof(rom) == "undefined") return;
        var element = document.createElement('a');
        var url = window.URL.createObjectURL(new Blob([rom.buffer], {type: 'application/octet-stream'}));
        element.setAttribute('href', url);
        element.setAttribute('download', "rom.gb");

        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
        window.URL.revokeObjectURL(url);
    };
});

</script>
</head>
<body>
<div class="container">
    <div class="filelist">
        <ul id="filelist">
        </ul>
        <button id="newfile">+</button>
    </div>
    <div class="editor" id="input"></div>
    <div class="emulator">
        <table><tr><td colspan="4">
            <div class="tabs">
                <input type="radio" name="emulator_display_mode" id="emulator_display_screen" checked /><label for="emulator_display_screen">Screen</label>
                <input type="radio" name="emulator_display_mode" id="emulator_display_vram" /><label for="emulator_display_vram">VRAM</label>
                <input type="radio" name="emulator_display_mode" id="emulator_display_bg0" /><label for="emulator_display_bg0">BG0</label>
                <input type="radio" name="emulator_display_mode" id="emulator_display_bg1" /><label for="emulator_display_bg1">BG1</label>
                <input type="radio" name="emulator_display_mode" id="emulator_display_rom" /><label for="emulator_display_rom">ROM</label>
                <input type="radio" name="emulator_display_mode" id="emulator_display_wram" /><label for="emulator_display_wram">WRam</label>
                <input type="radio" name="emulator_display_mode" id="emulator_display_hram" /><label for="emulator_display_hram">HRam</label>
                <input type="radio" name="emulator_display_mode" id="emulator_display_io" /><label for="emulator_display_io">IO</label>
            </div>
            <div class="emulator_screen_container">
                <canvas class="emulator_canvas_screen" id="emulator_screen_canvas" width="160" height="144"></canvas>
                <canvas class="emulator_vram_screen" id="emulator_vram_canvas" width="256" height="256" style="display: none"></canvas>
                <textarea style="height: 100%; width: 100%; display: none" id="emulator_display_text" readonly></textarea>
            </div>
        <tr><td class="right"><button id="download_rom">Download</button><td><button id="cpu_single_step">step</button><button id="cpu_frame_step">frame</button><input id="cpu_run_check" type="checkbox">run<td><button id="cpu_reset">Reset</button><td>
        <tr><td class="right">PC:<td id="cpu_pc">-<td class="right">A:<td id="cpu_a">-
        <tr><td class="right">SP:<td id="cpu_sp">-<td class="right">BC:<td id="cpu_bc">-
        <tr><td class="right">Flags:<td id="cpu_flags">-<td class="right">DE:<td id="cpu_de">-
        <tr><td class="right"><td><td class="right">HL:<td id="cpu_hl">-
        </table>
    </div>
    <div class="console"><textarea style="height: 100%; width: 100%" id="output" readonly></textarea></div>
</div>
</body>
</html>
